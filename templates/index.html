<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>LogonTracer</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.1.1/cytoscape.min.js" integrity="sha256-lEMQOla3MoXVNUAEGAuu4n1XouEYLyZP3SRqe6BhpTY=" crossorigin="anonymous"></script>
  <!-- Neo4j JavaScript Driver -->
  <script src="/static/node_modules/neo4j-driver/lib/browser/neo4j-web.js"></script>
</head>

<body>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">LogonTracer</a>
      <div class="collapse navbar-collapse">
        <form class="navbar-form navbar-left" role="search">
          <div class="form-group">
            <label class="sr-only" for="InputSelect">select</label>
            <select class="form-control" id="InputSelect">
              <option>Username</option>
              <option>Host</option>
            </select>
            <input class="form-control" type="text" value="administrator" id="query-input" size="10">
            <div id="itemForm"></div>
          </div>
          <input type="button" value="+" onclick="ItemField.add();" />
          <input type="button" value="-" onclick="ItemField.del();" />
          <div class="checkbox">
            <a>Event ID: </a>
            <label>
              <input type="checkbox" id="id4624" checked="checked"> 4624
            </label>
            <label>
              <input type="checkbox" id="id4625" checked="checked"> 4625
            </label>
            <label>
              <input type="checkbox" id="id4768" checked="checked"> 4768
            </label>
            <label>
              <input type="checkbox" id="id4769" checked="checked"> 4769
            </label>
            <label>
              <input type="checkbox" id="id4776" checked="checked"> 4776
            </label>
          </div>
          <a>Count: </a>
          <div class="form-group">
            <input class="form-control" type="text" value=0 id="count-input" size="1">
          </div>
          <button type="button" class="btn btn-default" onclick="createQuery()">search</button>
          <div class="btn-group">
            <a href="#" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
              Export <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li role="presentation"><a href="#" download="image.csv" id="export-csv" onclick="exportCSV()">CSV</a></li>
              <li role="presentation"><a href="#" download="image.json" id="export-json" onclick="exportJSON()">JSON</a></li>
              <li role="presentation"><a href="#" download="image.png" id="export-png" onclick="exportPNG()">PNG</a></li>
              <li role="presentation"><a href="#" download="image.jpeg" id="export-jpeg" onclick="exportJPEG()">JPEG</a></li>
            </ul>
          </div>
        </form>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-2 col-md-2 sidebar">
        <div class="list-group">
          <button type="button" class="list-group-item" onclick="createAllQuery()">All Users</button>
          <button type="button" class="list-group-item" onclick="createSystemQuery()">SYSTEM privileges</button>
          <button type="button" class="list-group-item" onclick="createRDPQuery()">RDP Logon</button>
          <button type="button" class="list-group-item" onclick="createNetQuery()">Network Logon</button>
          <button type="button" class="list-group-item" onclick="createBatchQuery()">Batch Logon</button>
          <button type="button" class="list-group-item" onclick="createServiceQuery()">Service Logon</button>
          <button type="button" class="list-group-item" onclick="create14068Query()">ms14-068 exploit failure</button>
          <button type="button" class="list-group-item" onclick="createFailQuery()">Logon failure</button>
        </div>
        <hr>
        <a>Add event value</a><br>
        <div class="btn-group" data-toggle="buttons">
          <label class="btn btn-default">
            <input type="checkbox" name="options" id="label-count" autocomplete="off">Count</label>
          <label class="btn btn-default">
            <input type="checkbox" name="options" id="label-type" autocomplete="off">Type</label>
          <label class="btn btn-default">
            <input type="checkbox" name="options" id="label-status" autocomplete="off">Status</label>
        </div>
        <hr>
        <a>Timeline</a><br>
        <div class="list-group">
          <button type="button" class="list-group-item" onclick="createAlltimeline()">Create All Users</button>
          <button type="button" class="list-group-item" onclick="searchTimeline()">Search</button>
        </div>
        <div class="btn-group">
          <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
            Download <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu">
            <li role="presentation"><a href="#" download="summary.csv" id="downloadsum-csv" onclick="downloadSummary()">Summary</a></li>
            <li role="presentation"><a href="#" download="details.csv" id="downloaddet-csv" onclick="downloadDetail()">Details</a></li>
          </ul>
        </div>
        <hr>
        <a>Upload</a><br>
        <button class="btn btn-default" data-toggle="modal" data-target="#UploadEVTX">Upload EVTX File</button>
      </div>
      <div class="col-sm-8 col-md-8 main">
        <div id="error"></div>
        <div id="cy" style="height:900px;"></div>
      </div>
      <div class="col-sm-2 col-md-2">
        <div class="container" id="rankUser"></div>
        <ul class="pager">
          <li><a onclick="pruserBack()">Back</a></li>
          <li><a onclick="pruserNext()">Next</a></li>
        </ul>
        <hr>
        <div class="container" id="rankHost"></div>
        <ul class="pager">
          <li><a onclick="prhostBack()">Back</a></li>
          <li><a onclick="prhostNext()">Next</a></li>
        </ul>
      </div>
    </div>
    <!-- Upload -->
    <div class="modal fade" id="UploadEVTX" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span>×</span></button>
            <h4 class="modal-title">Upload EVTX File</h4>
          </div>
          <div class="modal-body">
            <div id="zoneTime"></div>
            <input id="lefile" type="file" style="display:none">
            <div class="input-group">
              <input type="text" id="evtx_name" class="form-control" placeholder="select file...">
              <span class="input-group-btn"><button type="button" class="btn btn-info" onclick="$('input[id=lefile]').click();">Browse</button></span>
            </div>
            <div id="uploadBar"></div>
            <div id="status"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" onclick="file_upload()">Upload</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <a href="log" target="_blank"><button type="button" class="btn btn-default">Log</button></a>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      var neo = neo4j.default;
      //Neo4j access settings
      var driver = neo.driver("bolt://{{ server_ip }}", neo.auth.basic("{{ neo4j_user }}", "{{ neo4j_password }}"));
      var session = driver.session();
      var cy = cytoscape();
      var rankpageUser = 0
      var rankpageHost = 0

      var userqueryStr = 'MATCH (node:Username) RETURN node';
      var ipqueryStr = 'MATCH (node:IPAddress) RETURN node';
      pagerankQuery(userqueryStr, "User", rankpageUser);
      pagerankQuery(ipqueryStr, "Host", rankpageHost);
      exportCSV();
      downloadSummary();
      downloadDetail();

      var currentNumber = 0;
      var ItemField = {
        currentNumber: 0,
        itemTemplate: '<label class="sr-only" for="InputSelect">select</label>\
                                <select class="form-control" id="InputSelect_count_">\
                                <option>Username</option><option>Host</option></select>\
                                <input class="form-control" type="text" id="query-input_count_" size="10">\
                                <label class="sr-only" for="InputSelect">select</label>\
                                <select class="form-control" id="InputRule_count_">\
                                <option>OR</option><option>AND</option></select>',
        add: function() {
          currentNumber++;
          if (currentNumber <= 10) {
            var new_item = this.itemTemplate.replace(/_count_/mg, currentNumber);
            var new_area = document.createElement("div");
            new_area.setAttribute("id", "item" + currentNumber);
            var field = document.getElementById('itemForm');
            field.appendChild(new_area);
            document.getElementById('item' + currentNumber).innerHTML = new_item;
          }
        },
        del: function() {
          if (currentNumber == 0) {
            return;
          }
          var field = document.getElementById('itemForm');
          field.removeChild(field.lastChild);
          currentNumber--;
        }
      }

      var downMenu = '<div class="col-xs-3"><select class="form-control" id="utcTime"><option>UTC</option>';
      for (i = +14; i >= -12; i--) {
        downMenu += '<option>' + i + '</option>';
      }
      downMenu += '</select></div>';
      document.getElementById("zoneTime").innerHTML = downMenu;

      function buildGraph(graph, path) {
        for (idx in path) {
          if (Object.keys(path[idx]).length == 3) {
            objid = parseInt(path[idx].identity.low) + 100;
          } else {
            objid = parseInt(path[idx].identity.low) + 1000;
          }

          // Node
          if (Object.keys(path[idx]).length == 3) {
            var ndupflg = false;
            for (nidx in graph.nodes) {
              if (graph.nodes[nidx].data.objid == objid) {
                ndupflg = true;
              }
            }
            if (ndupflg) {
              continue;
            }

            if (path[idx].labels[0] == "Username") {
              nname = path[idx].properties.user
              nfsize = "10"
              nshape = "ellipse"
              if (path[idx].properties.rights == "system") {
                nwidth = "22"
                nheight = "22"
                ncolor = "#ff0000"
                nbcolor = "#ffc0cb"
                nfcolor = "#ff69b4"
              } else {
                nwidth = "15"
                nheight = "15"
                ncolor = "#0000cd"
                nbcolor = "#cee1ff"
                nfcolor = "#6da0f2"
              }
            }
            if (path[idx].labels[0] == "IPAddress") {
              nname = path[idx].properties.IP
              nshape = "diamond"
              nwidth = "15"
              nheight = "15"
              nfsize = "8"
              ncolor = "#2e8b57"
              nbcolor = "#98fb98"
              nfcolor = "#3cb371"
            }
            graph.nodes.push({
              "data": {
                "id": objid,
                "objid": objid,
                "nlabel": nname,
                "ncolor": ncolor,
                "nbcolor": nbcolor,
                "nfcolor": nfcolor,
                "nwidth": nwidth,
                "nheight": nheight,
                "nfsize": nfsize,
                "nshape": nshape,
                "label": path[idx].labels[0],
              }
            });
          } else {
            // Relationship
            var ldupflg = false;
            var label_count = document.getElementById("label-count").checked;
            var label_type = document.getElementById("label-type").checked;
            var label_status = document.getElementById("label-status").checked;
            var ename = path[idx].properties.id.low;
            if (label_count) {
              ename += " : " + path[idx].properties.count.low;
            }
            if (label_type) {
              ename += " : " + path[idx].properties.logintype;
            }
            if (label_status) {
              ename += " : " + path[idx].properties.status;
            }
            for (nidx in graph.edges) {
              if (graph.edges[nidx].data.objid == objid) {
                ldupflg = true;
              }
            }
            if (ldupflg) {
              continue;
            }
            graph.edges.push({
              "data": {
                "id": objid,
                "source": parseInt(path[parseInt(idx) - 1].identity.low) + 100,
                "target": parseInt(path[parseInt(idx) + 1].identity.low) + 100,
                "objid": objid,
                "elabel": ename,
                "label": path[idx].type,
                "distance": 5
              }
            });
          }
        }

        return (graph);
      }

      function drawGraph(graph, rootNode) {
        cy = cytoscape({
          container: document.getElementById("cy"),
          boxSelectionEnabled: false,
          autounselectify: true,
          style: cytoscape.stylesheet()
            .selector('node').css({
              "content": "data(nlabel)",
              "width": "data(nwidth)",
              "height": "data(nheight)",
              "color": "data(ncolor)",
              "font-size": "data(nfsize)",
              "background-color": "data(nbcolor)",
              "border-color": "data(nfcolor)",
              "border-style": "solid",
              "border-width": 3,
              "shape": "data(nshape)"
            })
            .selector('edge').css({
              "content": "data(elabel)",
              "font-size": "8",
              'curve-style': 'bezier',
              'target-arrow-shape': 'triangle',
              'width': 2,
              'line-color': '#ddd',
              'target-arrow-color': '#ddd'
            })
            .selector('.highlighted').css({
              'background-color': '#61bffc',
              'line-color': '#61bfcc',
              'transition-property': 'background-color, line-color, target-arrow-color',
              'transition-duration': '0.5s'
            }),
          elements: graph,
          layout: {
            name: 'cose',
            directed: true,
            roots: rootNode,
            animate: true,
            padding: 10
          }
        });

        cy.on('click', 'node', function(event) {
          console.log("clicked", this, event, this.id());
        });
      }

      function createAllQuery() {
        eidStr = getQueryID();
        eidStr = eidStr.slice(4);
        queryStr = 'MATCH (user)-[event]-(ip) WHERE ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function createSystemQuery() {
        eidStr = getQueryID();
        queryStr = 'MATCH (user)-[event]-(ip) WHERE user.rights = "system" ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function createRDPQuery() {
        eidStr = getQueryID();
        queryStr = 'MATCH (user)-[event]-(ip) WHERE event.logintype = 10 ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function createNetQuery() {
        eidStr = getQueryID();
        queryStr = 'MATCH (user)-[event]-(ip) WHERE event.logintype = 3 ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function createBatchQuery() {
        eidStr = getQueryID();
        queryStr = 'MATCH (user)-[event]-(ip) WHERE event.logintype = 4 ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function createServiceQuery() {
        eidStr = getQueryID();
        queryStr = 'MATCH (user)-[event]-(ip) WHERE event.logintype = 5 ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function create14068Query() {
        queryStr = 'MATCH (user)-[event]-(ip) WHERE event.status = "0xf" AND event.id = 4769 RETURN user, event, ip'
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function createFailQuery() {
        queryStr = 'MATCH (user)-[event]-(ip) WHERE event.id = 4625 RETURN user, event, ip'
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function createRankQuery(setStr, qType) {
        if (qType == "User") {
          whereStr = 'user.user = "' + setStr + '" ';
        }
        if (qType == "Host") {
          whereStr = 'ip.IP = "' + setStr + '" ';
        }

        eidStr = getQueryID()

        queryStr = 'MATCH (user)-[event]-(ip)  WHERE (' + whereStr + ') ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function getQueryID() {
        var id4624Ch = document.getElementById("id4624").checked;
        var id4625Ch = document.getElementById("id4625").checked;
        var id4768Ch = document.getElementById("id4768").checked;
        var id4769Ch = document.getElementById("id4769").checked;
        var id4776Ch = document.getElementById("id4776").checked;
        var countInt = document.getElementById("count-input").value;
        var eidStr = "AND ("
        if (id4624Ch) {
          eidStr = eidStr + "event.id = 4624 OR ";
        }
        if (id4625Ch) {
          eidStr = eidStr + "event.id = 4625 OR ";
        }
        if (id4768Ch) {
          eidStr = eidStr + "event.id = 4768 OR ";
        }
        if (id4769Ch) {
          eidStr = eidStr + "event.id = 4769 OR ";
        }
        if (id4776Ch) {
          eidStr = eidStr + "event.id = 4776 OR ";
        }
        eidStr = eidStr.slice(0, -4) + ")";
        eidStr = eidStr + " AND event.count > " + countInt;

        return eidStr;
      }

      function createQuery() {
        var selectVal = document.getElementById("InputSelect").value;
        var setStr = document.getElementById("query-input").value;

        if (selectVal == "Username") {
          whereStr = 'user.user =~ "' + setStr + '" ';
        } else {
          whereStr = 'ip.IP =~ "' + setStr + '" ';
        }

        for (i = 1; i <= currentNumber; i++) {
          if (document.getElementById("query-input" + i).value) {
            ruleStr = document.getElementById("InputRule" + i).value;
            if (document.getElementById("InputSelect" + i).value == "Username") {
              whereStr += ruleStr + ' user.user =~ "' + document.getElementById("query-input" + i).value + '" ';
            } else {
              whereStr += ruleStr + ' ip.IP =~ "' + document.getElementById("query-input" + i).value + '" ';
            }
          }
        }

        eidStr = getQueryID()
        queryStr = 'MATCH (user)-[event]-(ip)  WHERE (' + whereStr + ') ' + eidStr + ' RETURN user, event, ip';
        //console.log(queryStr);
        executeQuery(queryStr);
      }

      function executeQuery(queryStr) {
        var graph = {
          "nodes": [],
          "edges": []
        };

        session.run(queryStr)
          .subscribe({
            onNext: function(record) {
              //console.log(record.get('user'), record.get('event'), record.get('ip'));
              graph = buildGraph(graph, [record.get("user"), record.get("event"), record.get("ip")])
            },
            onCompleted: function() {
              session.close();
              if (graph.nodes.length == 0) {
                searchError();
              } else {
                //console.log(graph);
                rootNode = graph.nodes[0].id;
                drawGraph(graph, rootNode);
              }
            },
            onError: function(error) {
              console.log("Error: ", error);
            }
          });
      }

      function pruserBack() {
        rankpageUser -= 1;
        if (rankpageUser < 0) {
          rankpageUser = 0;
        }
        pagerankQuery(userqueryStr, "User", rankpageUser);
      }

      function pruserNext() {
        rankpageUser += 1;
        if (rankpageUser < 0) {
          rankpageUser = 0;
        }
        pagerankQuery(userqueryStr, "User", rankpageUser);
      }

      function prhostBack() {
        rankpageHost -= 1;
        if (rankpageHost < 0) {
          rankpageHost = 0;
        }
        pagerankQuery(ipqueryStr, "Host", rankpageHost);
      }

      function prhostNext() {
        rankpageHost += 1;
        if (rankpageHost < 0) {
          rankpageHost = 0;
        }
        pagerankQuery(ipqueryStr, "Host", rankpageHost);
      }

      function pagerankQuery(queryStr, dataType, currentPage) {
        var nodes = new Array();
        var html = '<div><table class="table table-striped"><thead><tr class="col-sm-2 col-md-2">\
                    <th class="col-sm-1 col-md-1">Rank</th><th class="col-sm-1 col-md-1">' + dataType +
                   '</th></tr></thead><tbody class="col-sm-2 col-md-2">';
        session.run(queryStr)
          .subscribe({
            onNext: function(record) {
              nodeData = record.get("node");
              if (dataType == "User") {
                nodes.push([nodeData.properties.user, nodeData.properties.rank]);
              }
              if (dataType == "Host") {
                nodes.push([nodeData.properties.IP, nodeData.properties.rank]);
              }
            },
            onCompleted: function() {
              session.close();
              nodes.sort(function(a, b) {
                var aa = a[1];
                var bb = b[1];
                if (aa < bb) {
                  return 1;
                }
                if (aa > bb) {
                  return -1;
                }
                return 0;
              });
              for (i = 10 * currentPage; i < nodes.length; i++) {
                if (i >= 10 * currentPage + 10) {
                  break;
                }
                html += '<tr><td>' + (i + 1) + '</td><td><a onclick="createRankQuery(\'' + nodes[i][0] + '\', \'' + dataType + '\')">' + nodes[i][0] + '</a></td></tr>';
                //console.log(nodes[i][0]);
                //console.log(hosts[i][0]);
              }
              html += '</tbody></table></div>';

              if (dataType == "User") {
                var rankElem = document.getElementById("rankUser");
              }
              if (dataType == "Host") {
                var rankElem = document.getElementById("rankHost");
              }
              rankElem.innerHTML = html;
            },
            onError: function(error) {
              console.log("Error: ", error);
            }
          });
      }

      function exportCSV() {
        var queryStr = 'MATCH (user:Username)-[event]-(ip:IPAddress) RETURN user, ip, event';
        var events = new Array();

        session.run(queryStr)
          .subscribe({
            onNext: function(record) {
              eventData = record.get("event");
              userData = record.get("user");
              ipData = record.get("ip");
              events.push([userData.properties.user, ipData.properties.IP,
                eventData.properties.id, eventData.properties.logintype,
                eventData.properties.status, eventData.properties.count
              ]);
            },
            onCompleted: function() {
              session.close();
              var rowData = "username,host,id,logontype,status,count\r\n";
              for (i = 0; i < events.length; i++) {
                rowData += events[i][0] + ",";
                rowData += events[i][1] + ",";
                rowData += events[i][2] + ",";
                rowData += events[i][3] + ",";
                rowData += events[i][4] + ",";
                rowData += events[i][5] + "\r\n";
              }
              var csvData = "data:application/csv,";
              csvData += encodeURIComponent(rowData);
              var exptag = document.getElementById('export-csv');
              exptag.href = csvData;

            },
            onError: function(error) {
              console.log("Error: ", error);
            }
          });
      }

      function exportJSON() {
        var jsonData = "data:application/json,";
        jsonData += encodeURIComponent(JSON.stringify(cy.json()));
        var exptag = document.getElementById('export-json');
        exptag.href = jsonData;
      }

      function exportPNG() {
        var png64 = cy.png();
        var exptag = document.getElementById('export-png');
        exptag.href = png64;
      }

      function exportJPEG() {
        var jpg64 = cy.png();
        var exptag = document.getElementById('export-jpeg');
        exptag.href = jpg64;
      }

      function downloadCSV(csvType) {
        var queryStr = 'MATCH (date:Date) MATCH (user:Username) RETURN date, user';
        var users = new Array();

        session.run(queryStr)
          .subscribe({
            onNext: function(record) {
              nodeData = record.get("user");
              dateData = record.get("date");
              users.push([nodeData.properties.user, nodeData.properties.counts,
                nodeData.properties.counts4624, nodeData.properties.counts4625,
                nodeData.properties.counts4768, nodeData.properties.counts4769,
                nodeData.properties.counts4776
              ]);
              starttime = dateData.properties.start;
              endtime = dateData.properties.end;
            },
            onCompleted: function() {
              session.close();

              var startDate = new Date(starttime);
              var rangeHours = Math.floor((Date.parse(endtime) - Date.parse(starttime)) / (1000 * 60 * 60)) + 1;
              var rawDate = "username,";
              if (csvType == "detail") {
                rawDate += "id,";
              }
              var countData = "";
              for (i = 0; i < rangeHours; i++) {
                rawDate += startDate.toISOString() + ",";
                startDate.setHours(startDate.getHours() + 1);
              }

              if (csvType == "summary") {
                for (i = 0; i < users.length; i++) {
                  countData += users[i][0] + "," + users[i][1] + "\r\n";
                }
              } else if (csvType == "detail") {
                for (i = 0; i < users.length; i++) {
                  countData += users[i][0];
                  for (j = 2; j <= 6; j++) {
                    if (j == 2) {
                      countData += ",4624,"
                    } else if (j == 3) {
                      countData += ",4625,"
                    } else if (j == 4) {
                      countData += ",4768,"
                    } else if (j == 5) {
                      countData += ",4769,"
                    } else if (j == 6) {
                      countData += ",4776,"
                    }
                    countData += users[i][j] + "\r\n";
                  }
                }
              }

              var csvData = "data:application/csv,";
              csvData += encodeURIComponent(rawDate + "\r\n");
              csvData += encodeURIComponent(countData);
              if (csvType == "summary") {
                var exptag = document.getElementById('downloadsum-csv');
              } else if (csvType == "detail") {
                var exptag = document.getElementById('downloaddet-csv');
              }
              exptag.href = csvData;
            },
            onError: function(error) {
              console.log("Error: ", error);
            }
          });
      }

      function downloadSummary() {
        downloadCSV("summary")
      }

      function downloadDetail() {
        downloadCSV("detail")
      }

      function createTimeline(queryStr, tableType) {
        var users = new Array();
        var starttime = "";
        var endtime = "";
        var weekTbl = new Array("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat");
        var bgcolorTbl = new Array("#ff7f50", "#efefef", "#efefef", "#efefef", "#efefef", "#efefef", "#b0c4de");

        if (tableType == "all") {
          var span = 'rowspan = "4"';
        }
        if (tableType == "search") {
          var span = 'rowspan = "4" colspan="2"';
        }
        var html = '<div class="table-responsive"><table class="table table-bordered table-condensed table-striped" style="background-color:#EEE;"><thead><tr>\
                          <th ' + span + '>Username</th>';

        session.run(queryStr)
          .subscribe({
            onNext: function(record) {
              dateData = record.get("date");
              nodeData = record.get("user");
              users.push([nodeData.properties.user, nodeData.properties.counts, nodeData.properties.detect, nodeData.properties.rights, nodeData.properties.counts4624,
                nodeData.properties.counts4625, nodeData.properties.counts4768, nodeData.properties.counts4769, nodeData.properties.counts4776
              ]);
              starttime = dateData.properties.start;
              endtime = dateData.properties.end;
            },
            onCompleted: function() {
              session.close();
              var startDate = new Date(starttime);
              var rangeHours = Math.floor((Date.parse(endtime) - Date.parse(starttime)) / (1000 * 60 * 60)) + 1;
              var thisyear = startDate.getFullYear();
              var thismonth = startDate.getMonth();
              var thisday = startDate.getDate();
              var thishour = startDate.getHours();
              var thisdow = startDate.getDay();
              var nextyear = null;
              var nrangeHours = 0;
              var weekd = 0;
              for (i = 1; i <= rangeHours; i++) {
                startDate.setHours(startDate.getHours() + 1);
                if (startDate.getFullYear() != thisyear) {
                  html += '<th colspan="' + (i - nrangeHours) + '">' + thisyear + '</th>';
                  thisyear = startDate.getFullYear();
                  nrangeHours = i;
                }
              }
              html += '<th colspan="' + (rangeHours - nrangeHours) + '">' + thisyear + '</th></tr><tr>';

              nrangeHours = 0;
              startDate = new Date(starttime);
              for (i = 1; i <= rangeHours; i++) {
                startDate.setHours(startDate.getHours() + 1);
                if (startDate.getMonth() != thismonth) {
                  html += '<th colspan="' + (i - nrangeHours) + '">' + (thismonth + 1) + '</th>';
                  thismonth = startDate.getMonth();
                  nrangeHours = i;
                }
              }
              html += '<th colspan="' + (rangeHours - nrangeHours) + '">' + (thismonth + 1) + '</th></tr><tr>';

              nrangeHours = 0;
              startDate = new Date(starttime);
              for (i = 1; i <= rangeHours; i++) {
                startDate.setHours(startDate.getHours() + 1);
                if (startDate.getDate() != thisday) {
                  html += '<th bgcolor="' + bgcolorTbl[thisdow + weekd] + '" colspan="' + (i - nrangeHours) + '">' + thisday + '(' + weekTbl[thisdow + weekd] + ')</th>';
                  if (thisdow + weekd >= 6) {
                    thisdow = 0 - (weekd + 1);
                  }
                  thisday = startDate.getDate();
                  nrangeHours = i;
                  weekd += 1;
                }
              }
              html += '<th bgcolor="' + bgcolorTbl[thisdow + weekd] + '" colspan="' + (rangeHours - nrangeHours) + '">' + thisday + '(' + weekTbl[thisdow + weekd] + ')</th></tr><tr>';

              for (i = 0; i < rangeHours; i++) {
                html += '<th>' + thishour + '</th>';
                thishour += 1;
                if (thishour >= 24) {
                  thishour = 0;
                }
              }

              html += '</tr></thead><tbody>';

              if (tableType == "all") {
                for (i = 0; i < users.length; i++) {
                  if (users[i][3] == "system") {
                    html += '<tr><td><font color="#ff7f50">' + users[i][0] + '</font></td>';
                  } else {
                    html += '<tr><td>' + users[i][0] + '</td>';
                  }
                  rowdata = users[i][1].split(",");
                  alerts = users[i][2].split(",");
                  for (j = 0; j < rowdata.length; j++) {
                    if (alerts[j] > 17) {
                      html += '<td bgcolor="#ff5aee">' + rowdata[j].split(".")[0] + '</td>';
                    } else if (alerts[j] > 16) {
                      html += '<td bgcolor="#ff8aee">' + rowdata[j].split(".")[0] + '</td>';
                    } else if (alerts[j] > 13) {
                      html += '<td bgcolor="#ffbaee">' + rowdata[j].split(".")[0] + '</td>';
                    } else if (alerts[j] > 10) {
                      html += '<td bgcolor="#ffeaee">' + rowdata[j].split(".")[0] + '</td>';
                    } else {
                      html += '<td>' + rowdata[j].split(".")[0] + '</td>';
                    }
                  }
                  html += '</tr>';
                }
              }

              if (tableType == "search") {
                for (i = 0; i < users.length; i++) {
                  if (users[i][3] == "system") {
                    html += '<tr><td rowspan = "5"><font color="#ff7f50">' + users[i][0] + '</font></td>';
                  } else {
                    html += '<tr><td rowspan = "5">' + users[i][0] + '</td>';
                  }

                  for (j = 4; j <= 8; j++) {
                    rowdata = users[i][j].split(",");
                    alerts = users[i][2].split(",");
                    if (j == 4) {
                      html += '<td>4624</td>';
                    } else if (j == 5) {
                      html += '<td>4625</td>';
                    } else if (j == 6) {
                      html += '<td>4768</td>';
                    } else if (j == 7) {
                      html += '<td>4769</td>';
                    } else if (j == 8) {
                      html += '<td>4776</td>';
                    }
                    for (k = 0; k < rowdata.length; k++) {
                      if (alerts[k] > 17) {
                        html += '<td bgcolor="#ff5aee">' + rowdata[k].split(".")[0] + '</td>';
                      } else if (alerts[k] > 16) {
                        html += '<td bgcolor="#ff8aee">' + rowdata[k].split(".")[0] + '</td>';
                      } else if (alerts[k] > 13) {
                        html += '<td bgcolor="#ffbaee">' + rowdata[k].split(".")[0] + '</td>';
                      } else if (alerts[k] > 10) {
                        html += '<td bgcolor="#ffeaee">' + rowdata[k].split(".")[0] + '</td>';
                      } else {
                        html += '<td>' + rowdata[k].split(".")[0] + '</td>';
                      }
                    }
                    html += '</tr>';
                  }
                }
              }
              html += '</tbody></table></div>';

              var timelineElem = document.getElementById("cy");
              timelineElem.innerHTML = html;
            },
            onError: function(error) {
              console.log("Error: ", error);
            }
          });
      }

      function createAlltimeline() {
        var queryStr = 'MATCH (date:Date) MATCH (user:Username) RETURN date, user';
        createTimeline(queryStr, "all");
      }

      function searchTimeline() {
        var selectVal = document.getElementById("InputSelect").value;
        var setStr = document.getElementById("query-input").value;

        if (selectVal == "Username") {
          whereStr = 'user.user =~ "' + setStr + '" ';
        } else {
          searchError();
        }

        for (i = 1; i <= currentNumber; i++) {
          if (document.getElementById("query-input" + i).value) {
            ruleStr = document.getElementById("InputRule" + i).value;
            if (document.getElementById("InputSelect" + i).value == "Username") {
              whereStr += ruleStr + ' user.user =~ "' + document.getElementById("query-input" + i).value + '" ';
            } else {
              searchError();
            }
          }
        }
        var queryStr = 'MATCH (date:Date) MATCH (user:Username) WHERE (' + whereStr + ') RETURN date, user';
        createTimeline(queryStr, "search");
      }

      function searchError() {
        var elemMsg = document.getElementById("error");
        elemMsg.innerHTML =
          '<div class="alert alert-warning alert-dismissible" id="alertfadeout" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="close">\
          <span aria-hidden="true">×</span></button><strong>WARNING</strong>: Search failed!</div>';
        $(document).ready(function() {
          $('#alertfadeout').fadeIn(2000).delay(4000).fadeOut(2000);
        });
      }

      function file_upload() {
        var upfile = document.getElementById("lefile");
        var timezone = document.getElementById("utcTime").value;
        document.getElementById("uploadBar").innerHTML = '';
        document.getElementById("status").innerHTML = '';

        var formData = new FormData();
        formData.append("file", upfile.files[0]);
        formData.append("timezone", timezone);
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.upload.addEventListener("progress", progressHandler, false);
        xmlhttp.addEventListener("load", completeHandler, false);
        xmlhttp.addEventListener("error", errorHandler, false);
        xmlhttp.addEventListener("abort", abortHandler, false);
        xmlhttp.open("POST", "upload", true);
        xmlhttp.send(formData);
      }

      function progressHandler(event) {
        var percent = (event.loaded / event.total) * 100;
        document.getElementById("uploadBar").innerHTML = '<h4>Upload ...</h4><div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" style="width: ' + Math.round(percent) + '%;">' + Math.round(percent) + '%</div></div>';
      }

      var parse_status = false;

      function completeHandler(event) {
        if (event.target.responseText == "FAIL") {
          document.getElementById("status").innerHTML = '<div class="alert alert-danger"><strong>ERROR</strong>: Upload Failed!</div>';
        }
        if (event.target.responseText == "SUCCESS") {
          parse_status = false
          document.getElementById("uploadBar").innerHTML = '<h4>Upload ...</h4><div class="progress"><div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" style="width: 100%;">SUCCESS</div></div>';
          var loop = function() {
            if (parse_status == false) {
              setTimeout(loop, 2000);
            }
            parseEVTX();
          }
          loop();
        }
      }

      function errorHandler(event) {
        document.getElementById("status").innerHTML = '<div class="alert alert-danger"><strong>ERROR</strong>: Upload Failed!</div>';
      }

      function abortHandler(event) {
        document.getElementById("status").innerHTML = '<div class="alert alert-info">Upload Aborted</div>';
      }

      $('input[id=lefile]').change(function() {
        $('#evtx_name').val($(this).val().replace("C:\\fakepath\\", ""));
      });

      function parseEVTX() {
        var xmlhttp2 = new XMLHttpRequest();
        xmlhttp2.open("GET", "/log");
        xmlhttp2.send();
        xmlhttp2.onreadystatechange = function() {
          if (xmlhttp2.readyState == 4) {
            if (xmlhttp2.status == 200) {
              var logdata = xmlhttp2.responseText.split(/\r\n|\r|\n/);
              var allrecode = logdata[3].split(" ")[5].replace(".", "");
              var nowdata = logdata[logdata.length - 2];
              if (nowdata.indexOf("Now loading") != -1) {
                var recordnum = nowdata.split(" ")[3];
                var percent = (recordnum / allrecode) * 100;
                document.getElementById("uploadBar").innerHTML = '<h4>Parsing  ...</h4><div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" style="width: ' + Math.round(percent) + '%;">' + Math.round(percent) + '%</div></div>';
              } else if (nowdata.indexOf("Script end") != -1) {
                document.getElementById("uploadBar").innerHTML = '<h4>Parsing  ...</h4><div class="progress"><div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" style="width: 100%;">SUCCESS</div></div>';
                parse_status = true;
              } else if (nowdata.indexOf("[!]") != -1) {
                document.getElementById("status").innerHTML = '<div class="alert alert-danger"><strong>ERROR</strong>: EVTX parse Failed!</div>';
                parse_status = true;
              }
            } else {
              document.getElementById("status").innerHTML = '<div class="alert alert-danger"><strong>ERROR</strong>: logontracer.log status =  ' + xmlhttp2.status + '</div>';
              parse_status = true;
            }
          }
        }
      }
    </script>
</body>

</html>
